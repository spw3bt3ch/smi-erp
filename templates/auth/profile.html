{% extends "base.html" %}

{% block title %}Profile - ERP Payroll System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">Profile Information</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- User Information -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-md font-medium text-gray-900 mb-4">Account Details</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Username</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.username }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.email }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Role</label>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                {{ current_user.role.title() }}
                            </span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Member Since</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.created_at.strftime('%B %d, %Y') }}</p>
                        </div>
                        {% if current_user.last_login %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Login</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.last_login.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Employee Information -->
                {% if current_user.employee %}
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-md font-medium text-gray-900 mb-4">Employee Details</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Employee ID</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.employee.employee_id }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.employee.full_name }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Job Title</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.employee.job_title }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Department</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.employee.department }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Hire Date</label>
                            <p class="mt-1 text-sm text-gray-900">{{ current_user.employee.hire_date.strftime('%B %d, %Y') }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Salary</label>
                            <p class="mt-1 text-sm text-gray-900">${{ "{:,.2f}".format(current_user.employee.salary) }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Recent Activity -->
            {% if current_user.employee %}
            <div class="mt-8">
                <h4 class="text-md font-medium text-gray-900 mb-4">Recent Payrolls</h4>
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <ul class="divide-y divide-gray-200">
                        {% set recent_payrolls = current_user.employee.payrolls | sort(attribute='created_at', reverse=true) %}
                        {% for payroll in recent_payrolls[:5] %}
                        <li class="px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 flex items-center justify-center rounded-full bg-blue-100">
                                            <span class="text-blue-600 font-medium text-sm">$</span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            Pay Period: {{ payroll.pay_period_start.strftime('%b %d') }} - {{ payroll.pay_period_end.strftime('%b %d, %Y') }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Status: 
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                                {% if payroll.status == 'processed' %}bg-green-100 text-green-800
                                                {% elif payroll.status == 'pending' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ payroll.status.title() }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-gray-900">
                                        ${{ "{:,.2f}".format(payroll.net_salary) }}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        {{ payroll.created_at.strftime('%b %d, %Y') }}
                                    </div>
                                    <div class="mt-2 flex space-x-2">
                                        <a href="{{ url_for('payroll.view', id=payroll.id) }}" 
                                           class="text-xs text-indigo-600 hover:text-indigo-900">View</a>
                                        <a href="{{ url_for('payroll.payslip', id=payroll.id) }}" 
                                           class="text-xs text-green-600 hover:text-green-900">Payslip</a>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% else %}
                        <li class="px-6 py-4 text-center text-gray-500">
                            No payroll records found
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
                        <a href="{{ url_for('payroll.index') }}" 
                           class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                            View All Payslips â†’
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Edit Profile Button -->
            <div class="mt-8 flex justify-end">
                <button onclick="editProfile()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Edit Profile
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Profile</h3>
            <form id="editForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" value="{{ current_user.email }}" 
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    {% if current_user.employee %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Name</label>
                        <input type="text" id="first_name" value="{{ current_user.employee.first_name }}" 
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input type="text" id="last_name" value="{{ current_user.employee.last_name }}" 
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="text" id="phone" value="{{ current_user.employee.phone or '' }}" 
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address</label>
                        <textarea id="address" rows="3" 
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">{{ current_user.employee.address or '' }}</textarea>
                    </div>
                    {% endif %}
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Password Change Section -->
    <div class="mt-8 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Change Password</h3>
            <form id="password-change-form" class="max-w-md">
                <div class="space-y-4">
                    <div>
                        <label for="current_password" class="block text-sm font-medium text-gray-700">Current Password</label>
                        <input type="password" id="current_password" name="current_password" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new_password" class="block text-sm font-medium text-gray-700">New Password</label>
                        <input type="password" id="new_password" name="new_password" required minlength="6"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" required minlength="6"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <button type="submit" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Change Password
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editProfile() {
    document.getElementById('editModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
}

document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('email', document.getElementById('email').value);
    {% if current_user.employee %}
    formData.append('first_name', document.getElementById('first_name').value);
    formData.append('last_name', document.getElementById('last_name').value);
    formData.append('phone', document.getElementById('phone').value);
    formData.append('address', document.getElementById('address').value);
    {% endif %}
    
    fetch('{{ url_for("auth.update_profile") }}', {
        method: 'POST',
        body: JSON.stringify({
            email: document.getElementById('email').value,
            {% if current_user.employee %}
            first_name: document.getElementById('first_name').value,
            last_name: document.getElementById('last_name').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value
            {% endif %}
        }),
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating profile');
    });
});

// Password change functionality
document.getElementById('password-change-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        current_password: formData.get('current_password'),
        new_password: formData.get('new_password'),
        confirm_password: formData.get('confirm_password')
    };
    
    // Validate passwords match
    if (data.new_password !== data.confirm_password) {
        alert('New passwords do not match');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("auth.change_password") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Password changed successfully!');
            this.reset();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('An error occurred while changing password');
        console.error('Error:', error);
    }
});
</script>
{% endblock %}
