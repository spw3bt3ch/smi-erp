{% extends "base.html" %}

{% block title %}QR Code Attendance - ERP Payroll System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- QR Scanner Interface -->
    <div class="bg-white shadow-lg rounded-lg p-8 mb-6">
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">QR Code Attendance</h2>
            <p class="text-gray-600 mb-6">Scan QR code at your office location to clock in/out</p>
            
            <!-- Current Time Display -->
            <div class="bg-indigo-50 rounded-lg p-6 mb-6">
                <div class="text-5xl font-bold text-indigo-600" id="current-time">--:--:--</div>
                <div class="text-sm text-gray-600 mt-2">Current Time</div>
            </div>
            
            <!-- QR Scanner Area -->
            <div class="bg-gray-50 rounded-lg p-8 mb-6">
                <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Scan QR Code</h3>
                <p class="text-gray-600 mb-4">Use your camera to scan the QR code displayed at your office location. The system will automatically clock you in or out based on your current status.</p>
                
                <!-- Camera Scanner -->
                <div class="relative">
                    <div id="camera-container" class="hidden">
                        <video id="camera-video" autoplay playsinline class="w-full h-64 bg-black rounded-lg"></video>
                        <canvas id="qr-canvas" class="hidden"></canvas>
                        <div class="mt-4 flex justify-center space-x-2">
                            <button onclick="stopCamera()" 
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                Stop Camera
                            </button>
                        </div>
                    </div>
                    
                    <div id="camera-controls">
                        <button onclick="startCamera()" 
                                class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Scan QR Code (Auto Clock In/Out)
                        </button>
                    </div>
                </div>
                
            </div>
            
            <!-- Current Status -->
            <div id="current-status" class="mb-6">
                <!-- Status will be loaded here -->
            </div>
            
            <!-- How It Works -->
            <div class="bg-green-50 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-medium text-green-900 mb-2">How QR Clock In/Out Works</h4>
                <div class="text-sm text-green-700 space-y-1">
                    <p><strong>• Clock In:</strong> If you haven't clocked in today, scanning will clock you in</p>
                    <p><strong>• Clock Out:</strong> If you're already clocked in, scanning will clock you out</p>
                    <p><strong>• Automatic:</strong> System detects your status and performs the correct action</p>
                    <p><strong>• Location:</strong> Must scan QR code at your office location</p>
                </div>
            </div>
            
            <!-- Location Info -->
            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-medium text-blue-900 mb-2">Office Locations</h4>
                <div class="text-sm text-blue-700 space-y-1">
                    {% if office_locations %}
                        {% for loc in office_locations %}
                        <p><strong>{{ loc.name }}:</strong> {{ loc.address }}</p>
                        {% endfor %}
                    {% else %}
                        <p class="text-blue-700">No office locations configured yet. Please contact your administrator.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Attendance History -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Recent QR Attendance</h3>
        <div id="attendance-history">
            <!-- History will be loaded here -->
        </div>
    </div>
</div>

<!-- QR Code Scanner Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
// Camera and QR scanning variables
let stream = null;
let scanning = false;
let scanInterval = null;

// Update current time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { hour12: false });
    document.getElementById('current-time').textContent = timeString;
}
setInterval(updateTime, 1000);
updateTime();

// Start camera for QR scanning
async function startCamera() {
    try {
        // Request camera access
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment', // Use back camera
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        const video = document.getElementById('camera-video');
        video.srcObject = stream;
        
        // Show camera container and hide controls
        document.getElementById('camera-container').classList.remove('hidden');
        document.getElementById('camera-controls').classList.add('hidden');
        
        // Start scanning for QR codes
        video.onloadedmetadata = function() {
            video.play();
            startQRScanning();
        };
        
        showNotification('Camera started. Point at QR code to scan.', 'info');
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        showNotification('Could not access camera. Please use file upload instead.', 'error');
    }
}

// Stop camera
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    
    scanning = false;
    
    // Hide camera container and show controls
    document.getElementById('camera-container').classList.add('hidden');
    document.getElementById('camera-controls').classList.remove('hidden');
    
    showNotification('Camera stopped.', 'info');
}

// Start QR code scanning
function startQRScanning() {
    if (scanning) return;
    
    scanning = true;
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('qr-canvas');
    const context = canvas.getContext('2d');
    
    scanInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Try to decode QR code
            try {
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    console.log('QR Code detected:', code.data);
                    processQRData(code.data);
                    stopCamera();
                }
            } catch (error) {
                // Continue scanning
            }
        }
    }, 100); // Check every 100ms
}



// Process QR code data
function processQRData(qrData) {
    try {
        // Validate JSON format
        const qrInfo = JSON.parse(qrData);
        
        // Show loading
        showNotification('Processing QR code...', 'info');
        
        // Send to server
        fetch('{{ url_for("qr_attendance.scan_qr") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ qr_data: qrData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.action === 'clock_in') {
                    showNotification(`Clocked in at ${data.location} at ${data.time}`, 'success');
                } else if (data.action === 'clock_out') {
                    showNotification(`Clocked out at ${data.location} at ${data.time}. Hours worked: ${data.hours_worked}`, 'success');
                }
                
                // Reload status and history
                loadCurrentStatus();
                loadAttendanceHistory();
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error processing QR code', 'error');
        });
        
    } catch (error) {
        showNotification('Invalid QR code format', 'error');
    }
}

// Load current attendance status
function loadCurrentStatus() {
    fetch('{{ url_for("attendance.status") }}', {
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('current-status');
        
        if (data.clocked_in && !data.clocked_out) {
            statusDiv.innerHTML = `
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <div class="text-sm font-medium text-green-800">Currently Clocked In</div>
                            <div class="text-sm text-green-600">Since: ${data.check_in_time}</div>
                        </div>
                    </div>
                </div>
            `;
        } else if (data.clocked_out) {
            statusDiv.innerHTML = `
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <div class="text-sm font-medium text-blue-800">Clocked Out</div>
                            <div class="text-sm text-blue-600">At: ${data.check_out_time}</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-gray-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <div class="text-sm font-medium text-gray-800">Not Clocked In</div>
                            <div class="text-sm text-gray-600">Scan QR code to clock in</div>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading status:', error);
    });
}

// Load attendance history
function loadAttendanceHistory() {
    fetch('{{ url_for("qr_attendance.attendance_history") }}', {
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const historyDiv = document.getElementById('attendance-history');
            const history = data.attendance_history;
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 text-center">No attendance records found</p>';
                return;
            }
            
            let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            html += '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check In</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check Out</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>';
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            history.forEach(att => {
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${att.date}</td>`;
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${att.check_in || '-'}</td>`;
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${att.check_out || '-'}</td>`;
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${att.hours_worked.toFixed(2)}h</td>`;
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">`;
                if (att.is_qr_attendance) {
                    html += '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">QR Code</span>';
                } else {
                    html += '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Manual</span>';
                }
                html += '</td></tr>';
            });
            
            html += '</tbody></table></div>';
            historyDiv.innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Error loading history:', error);
    });
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        type === 'info' ? 'bg-blue-500' : 'bg-gray-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentStatus();
    loadAttendanceHistory();
});

// Cleanup camera when page is unloaded
window.addEventListener('beforeunload', function() {
    stopCamera();
});
</script>
{% endblock %}
