{% extends "base.html" %}

{% block title %}My Attendance - ERP Payroll System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Clock In/Out Card -->
    <div class="bg-white shadow-lg rounded-lg p-8 mb-6">
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Attendance</h2>
            <p class="text-gray-600 mb-6">{{ today.date.strftime('%A, %B %d, %Y') if today else 'Today' }}</p>
            
            <!-- Current Time Display -->
            <div class="bg-indigo-50 rounded-lg p-6 mb-6">
                <div class="text-5xl font-bold text-indigo-600" id="current-time">--:--:--</div>
                <div class="text-sm text-gray-600 mt-2">Current Time</div>
            </div>
            
            <!-- Clock In/Out Status -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Clock In</div>
                    <div class="text-2xl font-bold text-green-600" id="check-in-time">
                        {% if today and today.check_in %}
                            {{ today.check_in.strftime('%H:%M:%S') }}
                        {% else %}
                            --:--:--
                        {% endif %}
                    </div>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Clock Out</div>
                    <div class="text-2xl font-bold text-red-600" id="check-out-time">
                        {% if today and today.check_out %}
                            {{ today.check_out.strftime('%H:%M:%S') }}
                        {% else %}
                            --:--:--
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4">
                <button onclick="clockIn()" id="clock-in-btn"
                        class="px-8 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200"
                        {% if today and today.check_in %}disabled{% endif %}>
                    <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Clock In
                </button>
                <button onclick="clockOut()" id="clock-out-btn"
                        class="px-8 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200"
                        {% if not today or not today.check_in or today.check_out %}disabled{% endif %}>
                    <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Clock Out
                </button>
            </div>
            
            {% if today and today.hours_worked %}
            <div class="mt-6 bg-blue-50 rounded-lg p-4">
                <div class="text-sm text-gray-600">Hours Worked Today</div>
                <div class="text-3xl font-bold text-blue-600">{{ "%.2f"|format(today.hours_worked) }} hrs</div>
                {% if today.overtime_hours and today.overtime_hours > 0 %}
                <div class="text-sm text-orange-600 mt-1">Overtime: {{ "%.2f"|format(today.overtime_hours) }} hrs</div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Status Indicator -->
            <div class="mt-4">
                {% if today %}
                    {% if today.status == 'late' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            Late Arrival
                        </span>
                    {% elif today.status == 'present' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Present
                        </span>
                    {% endif %}
                {% else %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        Not Clocked In
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Attendance History -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Attendance</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check In</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check Out</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for att in recent %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ att.date.strftime('%b %d, %Y') }}
                            {% if att.date == today.date %}
                                <span class="ml-2 text-xs text-indigo-600 font-medium">Today</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if att.check_in %}
                                {{ att.check_in.strftime('%H:%M:%S') }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if att.check_out %}
                                {{ att.check_out.strftime('%H:%M:%S') }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if att.hours_worked %}
                                {{ "%.2f"|format(att.hours_worked) }}h
                                {% if att.overtime_hours and att.overtime_hours > 0 %}
                                    <span class="text-orange-600 text-xs">(+{{ "%.1f"|format(att.overtime_hours) }}h OT)</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full 
                                {% if att.status == 'present' %}bg-green-100 text-green-800
                                {% elif att.status == 'late' %}bg-yellow-100 text-yellow-800
                                {% elif att.status == 'absent' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ att.status.title() }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No attendance records found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Update current time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { hour12: false });
    document.getElementById('current-time').textContent = timeString;
}
setInterval(updateTime, 1000);
updateTime();

// Clock In
function clockIn() {
    if (!confirm('Confirm clock in?')) return;
    
    // Disable button and show loading
    const btn = document.getElementById('clock-in-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Clocking In...';
    
    fetch('{{ url_for("attendance.clock_in") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('check-in-time').textContent = data.time;
            document.getElementById('clock-in-btn').disabled = true;
            document.getElementById('clock-out-btn').disabled = false;
            
            // Show success message
            showNotification('Clocked in successfully!', 'success');
            
            // Reload page after a short delay
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while clocking in', 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Clock Out
function clockOut() {
    if (!confirm('Confirm clock out?')) return;
    
    // Disable button and show loading
    const btn = document.getElementById('clock-out-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Clocking Out...';
    
    fetch('{{ url_for("attendance.clock_out") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('check-out-time').textContent = data.time;
            document.getElementById('clock-out-btn').disabled = true;
            
            // Show success message
            showNotification(`Clocked out successfully! Hours worked: ${data.hours_worked}`, 'success');
            
            // Reload page after a short delay
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while clocking out', 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Show notification
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Check attendance status on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('{{ url_for("attendance.status") }}', {
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.clocked_in) {
            document.getElementById('clock-in-btn').disabled = true;
            document.getElementById('check-in-time').textContent = data.check_in_time;
        }
        
        if (data.clocked_out) {
            document.getElementById('clock-out-btn').disabled = true;
            document.getElementById('check-out-time').textContent = data.check_out_time;
        } else if (data.clocked_in) {
            document.getElementById('clock-out-btn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Error checking status:', error);
    });
});
</script>
{% endblock %}
